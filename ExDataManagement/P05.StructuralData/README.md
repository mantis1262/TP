# Structural data

> NOTE: this document is under development: [The `P05.StructuralData\README.md` must be update #136](https://github.com/mpostol/TP/issues/136)

## Introduction

This solution contains two examples of using LINQ:

1. **LINQ to Objects** consisting of:
    * class library: `LinqToObjectsLib`  
      with `DataService` class that stores `Person` objects in `List<Person>` collection
    * unit tests written using NUnit 3: `LinqToObjectsLibTests`
    * sample console application: `LinqToObjectsApp`

1. **LINQ to SQL**:
    * class library: `LinqToSqlLib` with `PersonService` class  
      that provides operations for `Person` entities (objects of entity class `Person`)
    * unit tests written using NUnit 3: `LinqToSqlLibTests`  
      with testing database: `UnitTestData.mdf`
    * sample console application: `LinqToSqlApp`  
      with example database: `PersonData.mdf`

## Things to note

In both examples, LINQ operations remain essentially the same. The difference lies in the data source to which LINQ expressions are applied.

If the source implements `IEnumerable<T>` then operations with additional conditions are generally performed in memory, as in this case of LINQ to Objects.

If the source implements `IQueryable<T>` (which extends `IEnumerable<T>`) then operations with additional conditions may result in optimization, that translates to SQL queries enriched with these conditions that are generally performed on the database, as in the case of LINQ to SQL.

## LinqToObjectsLib

`Person` - POCO class (Plain Old CLR Object), used for accessing data in form of objects stored in memory

`DataService` - three methods that perform the same matching, but are implemented differently:

* `FilterPersonsByLastName_ForEach()` - using traditional iteration over collection
* `FilterPersonsByLastName_ExtensionMethod()` - using collection's
  extension method .Where() and lambda predicate
* `FilterPersonsByLastName()` - using LINQ expression performed over collection
  (`List<Person>` that implements `IEnumerable<Person>`)

`DataService` - another filtering method:

* `FilterPersonsByMinAge()` - method with another LINQ expression performed over collection
  (`List<Person>` that implements `IEnumerable<Person>`)

## LinqToSqlLib

Database and LINQ to SQL classes:

* `Database.mdf` - database with one table: `[dbo].[Persons]` but without data,
  used as a basis for creating `Persons.dbml` (below)
* `dbo.Persons.sql` - SQL script with table definition, when executed while connected
  to empty `Database.mdf` it creates corresponding `[dbo].[Persons]` table
* `Persons.dbml` - LINQ to SQL mapping diagram, used for automatic generation of
  LINQ to SQL classes in `Persons.designer.cs`
* `PersonsDataContext` - one of generated classes:
    * in its default constructor `public PersonsDataContext()` uses database connection string
      defined in the same project:  
      `global::LinqToSqlLib.Properties.Settings.Default.DatabaseConnectionString`
    * also provides other constructors, notably `public PersonsDataContext(string connection)`
      that allows to specify custom connection string (this will work as long as database specified
      this way has at least the same `[dbo].[Person]` table with expected schema)
* `Person` - generated entity class, used for accessing data representing rows of a table in database

Project settings:

* `Settings.settings` - contain definition of automatically added setting `DatabaseConnectionString`
  that points to `Database.mdf` in the same project

`PersonService` - filtering methods:

* `FilterPersonsByLastName()` - uses LINQ expression similar to one in `DataService.FilterPersonsByLastName()`
  its the data source is not not the `persons` collection, and instead it works on `context.Persons`
  (`System.Data.Linq.Table<Person>` that implements `IQueryable<Person>`)
* `FilterPersonsByMinAge()` - uses LINQ expression similar to one in `DataService.FilterPersonsByMinAge()`,
  but again its data source is not not the `persons` collection, and instead it works on `context.Persons`
  (`System.Data.Linq.Table<Person>` that implements `IQueryable<Person>`)
* `ChangeAgeThenFilterPersonsByMinAge()` - after preparing LINQ expression and before getting the
  results based on such expression, executes `foreach` loop to modify the age of all persons
  (and submit changes to database) - so the results would include these changes

`PersonService` - `IDisposable` support:

* Region of code generated by Visual Studio, with:
    * `Dispose(bool disposing)` - added `context.Dispose()` call to free database context created in constructor
    * `~PersonService()` - unused, commented-out finalizer (to be used only in special cases)
    * `Dispose()` - implementation of a method of `IDisposable` interface

## LinqToSqlLibTests

Contains unit tests for `LinqToSqlLib` and provides empty database `UnitTestData.mdf` with expected schema.

Project settings:

* `Settings.settings` - manually added file with definition of setting `UnitTestDataConnectionString`
  that points to `UnitTestData.mdf` in the same project

## LinqToSqlApp

Contains sample console application that uses `LinqToSqlLib` and provides database `PersonData.mdf` with expected schema
and example data.

Project settings:

* `Settings.settings` - manually added file with definition of setting `PersonDataConnectionString`
  that points to `PersonData.mdf` in the same project

## See also

- [Language Integrated Query (LINQ)](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/linq)
- [Query Syntax and Method Syntax in LINQ (C#)](https://docs.microsoft.com/en-us/dotnet/csharp/programming-guide/concepts/linq/query-syntax-and-method-syntax-in-linq)
- [LINQ to SQL tools in Visual Studio](https://docs.microsoft.com/en-us/visualstudio/data-tools/linq-to-sql-tools-in-visual-studio2?view=vs-2017)
- [LINQ to SQL](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/linq/)
- [Entity Framework Documentation](https://docs.microsoft.com/en-us/ef/)